# TranscribeFlow Session 2 - 2026-01-08

## Bug Fix: Pyannote Diarization PyTorch 2.6+ Compatibility

### Problem
Speaker diarization failing with error:
```
Weights only load failed. In PyTorch 2.6, we changed the default value of
the `weights_only` argument in `torch.load` from `False` to `True`.
WeightsUnpickler error: Unsupported global: GLOBAL torch.torch_version.TorchVersion
```

### Root Cause
- PyTorch 2.8.0 has `weights_only=True` by default (security change in 2.6+)
- pyannote.audio 3.3.2 uses `torch.load` internally without handling this
- Known issue: [pyannote/pyannote-audio#1908](https://github.com/pyannote/pyannote-audio/issues/1908)

### Solution
1. Upgraded pyannote.audio from 3.3.2 to 4.0.3
2. Changed API parameter `use_auth_token` to `token` (breaking change in 4.x)

### Files Changed
- `backend/workers/diarization.py:55` - `use_auth_token=` → `token=`
- `backend/requirements.txt` - `pyannote.audio>=3.3.0,<4.0.0` → `pyannote.audio>=4.0.0`

### Verification
Pipeline loads successfully without errors (tested with `Pipeline.from_pretrained()`)

---

## Bug Fix 2: AudioDecoder Not Defined

### Problem
After pyannote upgrade, new error: `name 'AudioDecoder' is not defined`

### Root Cause
- FFmpeg 8.0.1 installed (too new)
- torchcodec only supports FFmpeg 4-7
- pyannote 4.x tries to import AudioDecoder from torchcodec, fails silently, then crashes when using it

### Solution
Modified diarization worker to preload audio using torchaudio (which works with FFmpeg 8) and pass waveform dict to pyannote.

### Files Changed
- `backend/workers/diarization.py` - Added `_load_audio()` method, pass dict to pipeline

---

## Bug Fix 3: DiarizeOutput API Change

### Problem
`AttributeError: 'DiarizeOutput' object has no attribute 'itertracks'`

### Root Cause
pyannote 4.x changed output API from `.itertracks(yield_label=True)` to `.speaker_diarization`

### Solution
Updated code to handle both APIs with hasattr check.

### Files Changed
- `backend/workers/diarization.py` - Handle both 3.x and 4.x output APIs

### Verification
Diarization worker runs successfully with test audio.

---

## Bug Fix 4: m4a Format Not Supported by soundfile

### Problem
`Error opening '...m4a': Format not recognised.`

### Root Cause
- torchaudio using soundfile backend
- soundfile doesn't support m4a/AAC format

### Solution
Modified `_load_audio()` to detect unsupported formats and convert using ffmpeg to WAV before loading.

### Files Changed
- `backend/workers/diarization.py` - Added ffmpeg conversion for m4a/webm files

### Verification
m4a file loads successfully (8.3M samples at 16kHz = ~8.5 min audio)

---

## Feature: Whisper Anti-Hallucination Settings

### What
Added configurable parameters to prevent Whisper hallucinations like "Субтитры сделал DimaTorzok" during silence.

### Settings Added
- `whisper_no_speech_threshold` (0.6) - Skip silence segments
- `whisper_logprob_threshold` (-1.0) - Skip uncertain segments
- `whisper_compression_ratio_threshold` (2.4) - Skip repetitive text
- `whisper_hallucination_silence_threshold` (2.0) - Skip long silence gaps
- `whisper_condition_on_previous_text` (true) - Use context
- `whisper_initial_prompt` (null) - Optional context hint

### Files Changed
- `backend/config.py` - Added settings
- `backend/.env`, `.env.example` - Added environment variables
- `backend/engines/mlx_whisper.py` - Added WhisperSettings dataclass, pass to transcribe()
- `backend/workers/transcription_worker.py` - Load settings from config
- `backend/api/settings.py` - Expose settings in API
- `frontend/src/app/settings/page.tsx` - Added "Whisper Quality Settings" UI section

### Research
See `research/whisper-hallucinations/whisper-hallucinations-research.md`

---

## Whisper Settings: Подробное объяснение и рекомендации

### Сравнение: Whisper Default vs TranscribeFlow Default

| Параметр | Whisper Default | TranscribeFlow Default | Изменено? |
|----------|-----------------|------------------------|-----------|
| `no_speech_threshold` | 0.6 | 0.6 | Нет |
| `logprob_threshold` | -1.0 | -1.0 | Нет |
| `compression_ratio_threshold` | 2.4 | 2.4 | Нет |
| `hallucination_silence_threshold` | **None (выкл)** | **2.0 сек** | **ДА!** |
| `condition_on_previous_text` | True | True | Нет |
| `initial_prompt` | None | None | Нет |

**Вывод:** Единственное изменение — включён `hallucination_silence_threshold`. Это главный фильтр против "DimaTorzok".

---

### Детальное описание каждого параметра

#### 1. `no_speech_threshold` (0.0 — 1.0)
**Что делает:** Whisper для каждого 30-секундного сегмента считает вероятность "это тишина/шум, не речь". Если эта вероятность > порога — сегмент пропускается.

**Как работает:**
- Whisper выдаёт `no_speech_prob` для каждого сегмента (0.0 = точно речь, 1.0 = точно тишина)
- Если `no_speech_prob > no_speech_threshold` → текст этого сегмента отбрасывается

**Настройка:**
- **0.6 (default)** — баланс
- **0.3-0.5** — пропустит больше текста, включая шёпот и тихую речь, но и больше мусора
- **0.7-0.9** — строже, меньше галлюцинаций, но может потерять тихие фразы

**Рекомендация для DimaTorzok:** Можно поднять до 0.7, но это не главный фильтр.

---

#### 2. `logprob_threshold` (-10.0 — 0.0, всегда отрицательное!)
**Что делает:** Средняя логарифмическая вероятность токенов в сегменте. Показывает насколько модель "уверена" в распознанном тексте.

**Как работает:**
- 0.0 = 100% уверенность (никогда не бывает)
- -0.5 = высокая уверенность
- -1.0 = нормальная уверенность (default)
- -2.0 = низкая уверенность
- Если `avg_logprob < logprob_threshold` → сегмент отбрасывается

**Настройка:**
- **-1.0 (default)** — баланс
- **-0.5** — только очень уверенные сегменты (потеряете текст!)
- **-2.0** — пропустит неуверенные сегменты (больше мусора)

**Рекомендация для DimaTorzok:** Не трогать. Галлюцинации часто имеют высокую уверенность (модель "уверена" в DimaTorzok).

---

#### 3. `compression_ratio_threshold` (1.0 — 10.0)
**Что делает:** Фильтрует повторяющийся/зацикленный текст. Compression ratio = длина текста / длина сжатого текста.

**Как работает:**
- Нормальный текст: ratio ~1.5-2.5
- Повторы типа "да да да да да да": ratio > 3.0
- Если `compression_ratio > threshold` → сегмент отбрасывается

**Настройка:**
- **2.4 (default)** — баланс
- **1.5-2.0** — строже, фильтрует даже небольшие повторы
- **3.0-5.0** — мягче, пропустит умеренные повторы

**Рекомендация для DimaTorzok:** Не трогать. "DimaTorzok" не повторяющийся текст.

---

#### 4. `hallucination_silence_threshold` (секунды или None)
**Что делает:** ГЛАВНЫЙ ФИЛЬТР! Пропускает текст, который появляется после длинной паузы тишины.

**Как работает:**
- Если между сегментами тишина > N секунд, и потом появляется текст — этот текст скорее всего галлюцинация
- Именно так появляется "DimaTorzok" — в конце записи, после паузы

**Настройка:**
- **None (Whisper default)** — фильтр выключен!
- **2.0 (TranscribeFlow default)** — пропускает текст после 2+ сек тишины
- **0.5-1.0** — агрессивно, может отрезать реальную речь после коротких пауз
- **3.0-5.0** — мягко, пропустит короткие галлюцинации

**Рекомендация для DimaTorzok:** Это ГЛАВНАЯ настройка! Значение 1.0-2.0 должно убрать большинство галлюцинаций.

---

#### 5. `condition_on_previous_text` (true/false)
**Что делает:** Использует предыдущий распознанный текст как контекст для следующего сегмента.

**Как работает:**
- True: "Привет, как дела?" → следующий сегмент знает что перед ним было, лучше связность
- False: каждый сегмент независим

**Настройка:**
- **True (default)** — лучше связность, но если ошибка — может "застрять"
- **False** — независимые сегменты, меньше накопления ошибок

**Рекомендация для DimaTorzok:** Оставить True. Не влияет на галлюцинации в конце.

---

#### 6. `initial_prompt` (текст или None)
**Что делает:** Начальный контекст для модели. Помогает с терминологией, стилем, именами.

**Примеры:**
- "Это техническое интервью о программировании на Python"
- "Разговор участников: Иван (руководитель) и Мария (разработчик)"
- "Тема: машинное обучение, нейросети, трансформеры"

**Рекомендация для DimaTorzok:** Не влияет. Но может помочь с терминологией.

---

### Рекомендация: Минимальные изменения для борьбы с DimaTorzok

**Вариант 1: Только один фильтр (рекомендуется начать с этого)**
```
hallucination_silence_threshold = 2.0  (уже включено!)
```
Остальное оставить по умолчанию. Это уже должно убрать большинство галлюцинаций.

**Вариант 2: Если ещё появляются галлюцинации**
```
hallucination_silence_threshold = 1.0  (строже)
no_speech_threshold = 0.7  (строже к тишине)
```

**Вариант 3: Агрессивный (может потерять реальный текст!)**
```
hallucination_silence_threshold = 0.5
no_speech_threshold = 0.8
logprob_threshold = -0.8
```

**Что НЕ стоит трогать для борьбы с DimaTorzok:**
- `compression_ratio_threshold` — не поможет, DimaTorzok не повторяющийся
- `logprob_threshold` — галлюцинации часто имеют высокую уверенность
- `condition_on_previous_text` — не влияет

---

### TL;DR

1. **Все наши дефолты = дефолты Whisper**, кроме `hallucination_silence_threshold`
2. **`hallucination_silence_threshold = 2.0`** — единственное изменение, это ГЛАВНЫЙ фильтр
3. **Для начала не трогай ничего** — 2.0 сек должно помочь
4. **Если не помогло** — уменьши до 1.0 сек
5. **Остальные параметры** — для тонкой настройки качества, не для галлюцинаций
