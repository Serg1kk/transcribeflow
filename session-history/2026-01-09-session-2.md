# Session 2026-01-09-2

## GPU Support & Diarization Options - Design

### Выполнено:
- Исследовал текущую архитектуру диаризации (Pyannote 3.1 на CPU)
- Сравнил MLX Whisper vs WhisperX (качество транскрипции одинаковое, WhisperX лучше в word-level alignment)
- Исследовал hardware: M1 Pro vs M3 MacBook Air (throttling на Air без вентилятора)
- Провёл brainstorming сессию с пользователем
- Создал дизайн-документ для фичи

### Решения:
1. **Транскрипция**: MLX Whisper остаётся (уже GPU-оптимизирован)
2. **Диаризация**: 3 метода на выбор:
   - `none` — без диаризации
   - `fast` — Pyannote на MPS/GPU (быстро)
   - `accurate` — WhisperX alignment + diarization (точно, CPU)
3. **Device selection**: auto/mps/cpu для MacBook Air совместимости

### Файлы:
- `docs/backlog/03-gpu-diarization-options/design.md` (created)

### Результат:
- Дизайн готов и сохранён
- Следующий шаг: план реализации

---

## Implementation Plan Created

### Выполнено:
- Создан детальный план реализации с 9 задачами
- Каждая задача разбита на 5-7 шагов (TDD: тест → реализация → коммит)
- План включает все файлы, код и команды

### Файлы:
- `docs/plans/2026-01-09-gpu-diarization-options.md` (created)
- `docs/backlog/03-gpu-diarization-options/plan.md` (created)

### Задачи в плане:
1. Add WhisperX dependency
2. Update config with new settings
3. Add MPS support to Pyannote
4. Create WhisperX diarization worker
5. Update transcription worker
6. Update API settings
7. Update frontend UI
8. Manual testing
9. Full test suite

### Результат:
- План готов к выполнению

---

## Bug Fix: WhisperX Words Not Having Speakers

### Проблема:
- При использовании `accurate` режима диаризации, words не имели speaker labels
- Причина: использовались `result.words` из MLX Whisper вместо `whisperx_result.words`

### Выполнено:
- Исправлен баг в `transcription_worker.py`:
  - Добавлена переменная `words` которая переключается на WhisperX результат в accurate режиме
  - Добавлена переменная `actual_diarization_method` для отслеживания фактически использованного метода
- Добавлены метаданные настроек в `transcript.json`:
  - Новая секция `settings` с `diarization_method` и `compute_device`
  - Дублирование в `stats` для удобства

### Файлы:
- `backend/workers/transcription_worker.py` (modified)

### Тесты:
- 12 passed, 1 warning

### Результат:
- Перезапусти сервер и протестируй accurate режим снова
