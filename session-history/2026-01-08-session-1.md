# TranscribeFlow Session 1 - 2026-01-08

## Обзор проекта
TranscribeFlow - локальное приложение для транскрипции аудио на Apple Silicon Mac.
- **Backend**: FastAPI + Python (порт 8000)
- **Frontend**: Next.js (порт 3001)
- **ASR Engine**: MLX Whisper (локальный)
- **Diarization**: Pyannote (определение спикеров)

## Что было сделано в этой сессии

### 1. Исправление CORS ошибок
- **Проблема**: Frontend на порту 3001, backend разрешал только 3000
- **Решение**: Добавил `localhost:3001` в CORS origins (`backend/main.py:35`)

### 2. Исправление MLX Whisper моделей
- **Проблема**: Неправильные имена репозиториев на HuggingFace (large-v3-turbo не имеет суффикса -mlx)
- **Решение**: Создал маппинг MODEL_REPOS в `backend/engines/mlx_whisper.py`
- Доступные модели: tiny, base, small, medium, large-v2, large-v3, large-v3-turbo, turbo

### 3. Обновление зависимостей
- `mlx-whisper`: 0.1.0 → 0.4.3 (поддержка safetensors)
- `pyannote.audio`: 3.1.1 → 3.3.2 (совместимость с torchaudio)
- `huggingface_hub`: 1.2.4 → 0.36.0 (поддержка use_auth_token)

### 4. Добавление отображения ошибок в UI
- Добавил `error_message` в API response (`backend/api/transcribe.py`)
- Показ ошибок в очереди красным блоком (`frontend/src/components/TranscriptionQueue.tsx`)

### 5. Мульти-файл загрузка
- Изменил FileUpload для поддержки выбора нескольких файлов
- "Select file(s)" + drag & drop multiple
- Прогресс загрузки для batch uploads

### 6. Отображение размера файла и длительности
- Добавил `file_size` в модель базы данных
- Показ размера в MB и длительности аудио в очереди

### 7. Tracking времени обработки
- Новые поля в БД: `transcription_time_seconds`, `diarization_time_seconds`
- Раздельный трекинг времени ASR и diarization в worker
- Отображение в UI: "Total: 2m 30s | ASR: 1m 45s | Diarization: 45s"

### 8. Кнопки очистки истории
- "Clear Failed" - удалить только failed транскрипции
- "Clear All" - удалить всё
- API endpoint: DELETE `/api/transcribe/history/{all|failed}`
- Скрипт: `clean_db.sh failed` или `clean_db.sh all`

### 9. Редактируемые Settings
- Создал `config.json` сервис с приоритетом над `.env`
- Путь: `~/.transcribeflow/config.json`
- PUT endpoint для сохранения настроек
- Новый Settings UI с секциями:
  - Transcription (engine, model)
  - Speaker Diarization (enabled, min/max speakers, HF token)
  - Cloud ASR Providers (AssemblyAI, OpenAI, Deepgram) - помечены TBD
  - LLM Post-Processing (Gemini, OpenRouter) - помечены TBD
  - Feature Status (что реализовано, что TBD)

### 10. Обновлённые .env файлы
- Полный список переменных с комментариями
- `backend/.env` и `.env.example`

## Структура ключевых файлов

```
transcribeflow/
├── backend/
│   ├── .env                      # Конфигурация (fallback)
│   ├── config.py                 # Settings с config.json приоритетом
│   ├── main.py                   # FastAPI app, CORS
│   ├── requirements.txt          # Зависимости
│   ├── api/
│   │   ├── transcribe.py         # API транскрипции + history delete
│   │   └── settings.py           # GET/PUT settings
│   ├── engines/
│   │   └── mlx_whisper.py        # MODEL_REPOS маппинг
│   ├── models/
│   │   ├── transcription.py      # DB модель + timing fields
│   │   └── database.py           # SQLite в ~/.transcribeflow/
│   ├── workers/
│   │   ├── transcription_worker.py  # Timing tracking
│   │   └── diarization.py        # Pyannote + torchaudio workaround
│   └── services/
│       └── config_service.py     # config.json read/write
├── frontend/
│   └── src/
│       ├── app/settings/page.tsx # Editable settings UI
│       ├── components/
│       │   ├── FileUpload.tsx    # Multi-file upload
│       │   └── TranscriptionQueue.tsx  # Timing + error display
│       └── lib/api.ts            # API types
├── start.sh                      # Запуск обоих серверов
├── clean_db.sh                   # Очистка БД
└── session-history/              # История сессий
```

## Конфигурация

### ~/.transcribeflow/config.json (приоритет)
```json
{
  "default_model": "large-v3-turbo",
  "diarization_enabled": true,
  "hf_token": "hf_xxx..."
}
```

### backend/.env (fallback)
```
TRANSCRIBEFLOW_DEFAULT_MODEL=large-v3-turbo
TRANSCRIBEFLOW_DIARIZATION_ENABLED=true
TRANSCRIBEFLOW_HF_TOKEN=hf_xxx...
```

## База данных
- Путь: `~/.transcribeflow/transcribeflow.db` (SQLite)
- При изменении схемы нужно удалить и пересоздать

## Известные проблемы / TODO
1. Cloud ASR engines (AssemblyAI, OpenAI, Deepgram) - не реализованы
2. LLM post-processing (Gemini, OpenRouter) - не реализованы
3. FFmpeg 8 не совместим с torchcodec (но pyannote fallback на torchaudio работает)

## Команды для запуска

```bash
# Удалить старую БД (при изменении схемы)
rm ~/.transcribeflow/transcribeflow.db

# Запустить оба сервера
cd "/Users/serg1kk/AI Transcription/transcribeflow"
./start.sh

# Или раздельно:
# Terminal 1 - Backend
cd backend && source .venv/bin/activate && python -m uvicorn main:app --host 127.0.0.1 --port 8000

# Terminal 2 - Frontend
cd frontend && npm run dev
```

## URLs
- Frontend: http://localhost:3001
- Backend API: http://localhost:8000
- Settings: http://localhost:3001/settings
